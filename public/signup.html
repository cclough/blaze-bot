<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Blaze Test - Sign Up</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://js.stripe.com/v3/"></script>

  <link rel="stylesheet" href="styles.css" />
  <script src="app.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@400;700;900&family=Rajdhani:wght@400;600;700&family=Russo+One&family=Audiowide&family=Black+Ops+One&family=Bungee&family=Monoton&family=Wallpoet&family=Electrolize&family=Share+Tech+Mono&family=Iceberg&family=Faster+One&family=Megrim&family=Jura:wght@300;400;500;600;700&family=Saira+Stencil+One&family=Turret+Road:wght@200;300;400;500;700;800&family=Michroma&family=Syncopate:wght@400;700&family=Teko:wght@300;400;500;600;700&family=Squada+One&family=Aldrich&family=Quantico:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet" />

  <style>
    .signup-form {
      padding: 1rem 2.5rem 2rem 2.5rem;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 140, 0, 0.5) rgba(0, 0, 0, 0.2);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      color: #ffaa00;
      font-family: 'Audiowide', 'Orbitron', 'Electrolize', 'Rajdhani', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 0.8rem;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 140, 0, 0.3);
      border-radius: 8px;
      color: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: rgba(255, 140, 0, 0.6);
      box-shadow: 0 0 10px rgba(255, 140, 0, 0.2);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .waiver-section {
      margin: 2rem 0;
    }

    .waiver-title {
      color: #ffffff;
      font-family: 'Audiowide', 'Orbitron', 'Electrolize', 'Rajdhani', sans-serif;
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      text-align: center;
    }

    .waiver-item {
      display: flex;
      align-items: flex-start;
      gap: 0.8rem;
      margin-bottom: 1.2rem;
      padding: 1rem;
      background: rgba(255, 140, 0, 0.05);
      border: 1px solid rgba(255, 140, 0, 0.2);
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .waiver-item:hover {
      border-color: rgba(255, 140, 0, 0.4);
      box-shadow: 0 0 10px rgba(255, 140, 0, 0.1);
    }

    .waiver-checkbox {
      width: 18px;
      height: 18px;
      margin-top: 2px;
      accent-color: #ff8c00;
      cursor: pointer;
      flex-shrink: 0;
    }

    .waiver-text {
      color: #dddddd;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 0.85rem;
      line-height: 1.4;
      flex: 1;
    }

    .waiver-text strong {
      color: #ff8c00;
      font-weight: 600;
    }

    .form-error {
      color: #ff6b6b;
      font-size: 0.8rem;
      margin-top: 0.5rem;
      display: none;
    }

    .signup-form::-webkit-scrollbar {
      width: 6px;
    }

    .signup-form::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }

    .signup-form::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, rgba(255, 140, 0, 0.6), rgba(255, 69, 0, 0.6));
      border-radius: 3px;
      animation: scroll-glow 2s infinite;
    }

    .signup-form::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, rgba(255, 140, 0, 0.8), rgba(255, 69, 0, 0.8));
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .signup-form {
        padding: 1rem 1.5rem 1.5rem 1.5rem;
      }
      
      .waiver-text {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>

  <div class="background-container" id="background">
    <div class="cyber-grid"></div>
    <div class="glitch-overlay"></div>
    <!-- White Blood Cells will be dynamically generated by JavaScript -->
  </div>

  <div class="content-overlay" id="modal">
    <div class="content-card">
        <div class="digital-noise"></div>
        <div class="signup-form">
            <div class="blaze-logo">
                <span class="blaze-letter b">b</span>
                <span class="blaze-letter l">l</span>
                <span class="blaze-letter a">a</span>
                <span class="blaze-letter z">z</span>
                <span class="blaze-letter e">e</span>
            </div>
            
            <h2 data-text="Complete Your Registration">Complete Your Registration</h2>
            
            <form id="signup-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="age">Age</label>
                  <input type="number" id="age" name="age" min="18" max="120" required>
                  <div class="form-error" id="age-error">Age must be 18 or older</div>
                </div>
                <div class="form-group">
                  <label for="gender">Gender</label>
                  <select id="gender" name="gender" required>
                    <option value="">Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                    <option value="prefer-not-to-say">Prefer not to say</option>
                  </select>
                  <div class="form-error" id="gender-error">Please select your gender</div>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label for="height">Height (cm)</label>
                  <input type="number" id="height" name="height" min="100" max="250" required>
                  <div class="form-error" id="height-error">Please enter a valid height</div>
                </div>
                <div class="form-group">
                  <label for="weight">Weight (kg)</label>
                  <input type="number" id="weight" name="weight" min="30" max="300" required>
                  <div class="form-error" id="weight-error">Please enter a valid weight</div>
                </div>
              </div>
              
              <div class="waiver-section">
                <h3 class="waiver-title">Terms & Conditions</h3>
                
                <div class="waiver-item">
                  <input type="checkbox" id="waiver1" name="waiver1" class="waiver-checkbox" required>
                  <div class="waiver-text">
                    <strong>Informational only</strong> – I understand this inflammation test is <strong>not an FDA-cleared diagnostic</strong> and is provided for wellness insight; it does <strong>not constitute medical advice</strong>.
                  </div>
                </div>
                
                <div class="waiver-item">
                  <input type="checkbox" id="waiver2" name="waiver2" class="waiver-checkbox" required>
                  <div class="waiver-text">
                    <strong>Collection risks & redo</strong> – I accept all risks of at-home blood sampling (e.g., bruising, infection) and know a bad or delayed sample may require a new draw at my cost.
                  </div>
                </div>
                
                <div class="waiver-item">
                  <input type="checkbox" id="waiver3" name="waiver3" class="waiver-checkbox" required>
                  <div class="waiver-text">
                    <strong>Result limits</strong> – Cytokine levels swing with illness, exercise, meds, etc.; a single reading may not reflect my usual baseline. I'll talk to a doctor before acting on the data.
                  </div>
                </div>
                
                <div class="waiver-item">
                  <input type="checkbox" id="waiver4" name="waiver4" class="waiver-checkbox" required>
                  <div class="waiver-text">
                    <strong>Privacy</strong> – My data may be stored securely and used in de-identified, aggregated form to improve the product; it won't be shared or sold with personal identifiers.
                  </div>
                </div>
                
                <div class="waiver-item">
                  <input type="checkbox" id="waiver5" name="waiver5" class="waiver-checkbox" required>
                  <div class="waiver-text">
                    <strong>Liability waiver</strong> – I release <strong>Blaze</strong> and lab partners from any claims arising from this test, except for gross negligence or willful misconduct.
                  </div>
                </div>
                
                <div class="waiver-item">
                  <input type="checkbox" id="waiver6" name="waiver6" class="waiver-checkbox" required>
                  <div class="waiver-text">
                    <strong>Age & jurisdiction</strong> – I'm <strong>18+</strong>, give informed consent, and agree any dispute is governed by California law and binding arbitration in San Francisco.
                  </div>
                </div>
              </div>
            </form>
        </div>
        
        <div class="button-container">
            <button id="proceed-button" type="submit" form="signup-form">
                <span>Proceed to Payment</span>
            </button>
        </div>
    </div>
  </div>

  <div id="checkout" style="display: none; width: 100vw; height: 100vh; top: 0; left: 0; z-index: 9999;"></div>

  <script>
    Telegram.WebApp.ready();
    
    const proceedButton = document.getElementById('proceed-button');
    const signupForm = document.getElementById('signup-form');
    const checkoutElement = document.getElementById('checkout');
    const modalElement = document.getElementById('modal');
    const backgroundElement = document.getElementById('background');

    let stripe; // Don't initialize yet

    // Form validation
    function validateForm() {
      let isValid = true;
      
      // Clear previous errors
      document.querySelectorAll('.form-error').forEach(error => {
        error.style.display = 'none';
      });
      
      // Validate age
      const age = document.getElementById('age').value;
      if (!age || age < 18) {
        document.getElementById('age-error').style.display = 'block';
        isValid = false;
      }
      
      // Validate gender
      const gender = document.getElementById('gender').value;
      if (!gender) {
        document.getElementById('gender-error').style.display = 'block';
        isValid = false;
      }
      
      // Validate height
      const height = document.getElementById('height').value;
      if (!height || height < 100 || height > 250) {
        document.getElementById('height-error').style.display = 'block';
        isValid = false;
      }
      
      // Validate weight
      const weight = document.getElementById('weight').value;
      if (!weight || weight < 30 || weight > 300) {
        document.getElementById('weight-error').style.display = 'block';
        isValid = false;
      }
      
      // Validate all waivers are checked
      const waivers = document.querySelectorAll('.waiver-checkbox');
      let allWaiversChecked = true;
      waivers.forEach(waiver => {
        if (!waiver.checked) {
          allWaiversChecked = false;
        }
      });
      
      if (!allWaiversChecked) {
        Telegram.WebApp.showAlert('Please accept all terms and conditions to proceed.');
        isValid = false;
      }
      
      return isValid;
    }

    // Handle form submission
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!validateForm()) {
        return;
      }
      
      // Add loading state to button
      proceedButton.classList.add('loading');
      
      // Collect form data
      const formData = {
        age: document.getElementById('age').value,
        gender: document.getElementById('gender').value,
        height: document.getElementById('height').value,
        weight: document.getElementById('weight').value,
        waivers_accepted: true
      };
      
      try {
        const tgid = Telegram.WebApp.initDataUnsafe.user.id;
        const response = await fetch(`https://blaze-bot-five.vercel.app/api/create-checkout?tgid=${tgid}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });
        
        const { client_secret, publishable_key, error } = await response.json();

        if (error) {
          console.error('Error from backend:', error);
          Telegram.WebApp.showAlert('Could not initiate payment. ' + error);
          proceedButton.classList.remove('loading');
          return;
        }

        if (!client_secret) {
          console.error('Client secret not received');
          Telegram.WebApp.showAlert('Could not initiate payment. Missing client secret.');
          proceedButton.classList.remove('loading');
          return;
        }
        
        // Initialize Stripe with the publishable key from the server
        stripe = Stripe(publishable_key || 'pk_test_51RSmgFHILCjSlj9r8aaZUKvBDt66nmhRiw5rNa6MbAoOC2PU2WCSfvqMkkIc8Z6KPin0bRJbuHQR0hayywU552wy00CtP4mF3r');
        
        modalElement.style.display = 'none';
        backgroundElement.style.display = 'none';
        checkoutElement.style.display = 'block';

        const checkout = await stripe.initEmbeddedCheckout({
          clientSecret: client_secret,
        });

        checkout.mount('#checkout');
        
      } catch (e) {
        console.error('Error processing signup:', e);
        Telegram.WebApp.showAlert('Could not process signup. ' + e.message);
        proceedButton.classList.remove('loading');
      }
    });
  </script>

</body>
</html> 