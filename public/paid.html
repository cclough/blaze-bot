<!DOCTYPE html>
<html><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Payment Status</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://js.stripe.com/v3/"></script>
<style>
  body {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: system-ui;
    text-align: center;
    padding: 20px;
    box-sizing: border-box;
  }
  #message {
    font-size: 16px;
    margin-bottom: 20px;
  }
  .status-complete { color: #22c55e; }
  .status-open { color: #f59e0b; }
  .status-expired { color: #ef4444; }
  .status-error { color: #ef4444; }
</style>
</head>
<body>

<div id="message">Loading payment status...</div>

<script>
  Telegram.WebApp.ready();
  
  const stripe = Stripe('YOUR_STRIPE_PUBLISHABLE_KEY');
  const messageDiv = document.getElementById('message');

  const urlParams = new URLSearchParams(window.location.search);
  const sessionId = urlParams.get('session_id');

  if (sessionId) {
    stripe.retrieveCheckoutSession(sessionId).then(({session, error}) => {
      if (error) {
        console.error('Error retrieving session:', error);
        messageDiv.textContent = "Error retrieving payment status. Please check with support.";
        messageDiv.className = 'status-error';
        Telegram.WebApp.showAlert("Error: " + error.message);
        return;
      }

      if (!session) {
        messageDiv.textContent = "Could not retrieve payment session details.";
        messageDiv.className = 'status-error';
        Telegram.WebApp.showAlert("Could not retrieve payment session details.");
        return;
      }

      let userMessage = '';
      let messageClass = '';
      let autoClose = false;

      switch (session.status) {
        case 'complete':
          userMessage = "✅ Payment successful! Thank you. Your QR code will be sent in the chat.";
          messageClass = 'status-complete';
          autoClose = true;
          break;
        case 'open':
          userMessage = "⏳ Your payment is still processing. We'll notify you once completed.";
          messageClass = 'status-open';
          break;
        case 'expired':
          userMessage = "⚠️ Payment session expired. Please go back and try again.";
          messageClass = 'status-expired';
          break;
        default:
          userMessage = `⚠️ Payment status: ${session.status}. Please contact support if this persists.`;
          messageClass = 'status-error';
          break;
      }
      messageDiv.textContent = userMessage;
      messageDiv.className = messageClass;

      if (autoClose && window.Telegram && window.Telegram.WebApp) {
        Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        setTimeout(() => {
          Telegram.WebApp.close();
        }, 3000);
      }

    }).catch(err => {
      console.error('Stripe.js error:', err);
      messageDiv.textContent = "An error occurred while checking payment status.";
      messageDiv.className = 'status-error';
      Telegram.WebApp.showAlert("Stripe.js error: " + err.message);
    });
  } else {
    messageDiv.textContent = "Invalid payment session. Please return to the bot and try again.";
    messageDiv.className = 'status-error';
    Telegram.WebApp.showAlert("Invalid payment session.");
    if (window.Telegram && window.Telegram.WebApp) {
        setTimeout(() => {
        }, 3000);
    }
  }
</script>
</body></html>