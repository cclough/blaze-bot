<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Blaze Test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://js.stripe.com/v3/"></script>

  <link rel="stylesheet" href="/styles.css" />
  <script src="/app.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@400;700;900&family=Rajdhani:wght@400;600;700&family=Russo+One&family=Audiowide&family=Black+Ops+One&family=Bungee&family=Monoton&family=Wallpoet&family=Electrolize&family=Share+Tech+Mono&family=Iceberg&family=Faster+One&family=Megrim&family=Jura:wght@300;400;500;600;700&family=Saira+Stencil+One&family=Turret+Road:wght@200;300;400;500;700;800&family=Michroma&family=Syncopate:wght@400;700&family=Teko:wght@300;400;500;600;700&family=Squada+One&family=Aldrich&family=Quantico:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet" />

  <style>
    /* body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: system-ui;
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
      background: #f9fafb;
    } */
    #message {
      font-size: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin-bottom: 20px;
      padding: 2rem 2.5rem;
      background: #000;
      color: white;
      border-radius: 1rem;
      box-shadow: 0 4px 18px rgba(0,0,0,.08);
    }
    .status-complete { color: #22c55e; }
    .status-open { color: #f59e0b; }
    .status-expired { color: #ef4444; }
    .status-error { color: #ef4444; }
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>


</head>
<body>


  <div class="background-container" id="background">
    <div class="cyber-grid"></div>
    <div class="glitch-overlay"></div>
    <!-- White Blood Cells will be dynamically generated by JavaScript -->
  </div>

  <div class="content-overlay" id="modal">
    <div class="content-card">
        <div class="digital-noise"></div>


        <div id="message">
          <div class="spinner"></div>
          Loading payment status...
        </div>


      </div>
    </div>



  <script>
    Telegram.WebApp.ready();
    
    const messageDiv = document.getElementById('message');

    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id');

    function updateMessage(text, className) {
      messageDiv.innerHTML = text; // Remove spinner
      messageDiv.className = className;
    }

    if (sessionId) {
      console.log('Processing payment for session:', sessionId);
      
      // Get telegram ID from Telegram WebApp
      const telegramId = Telegram.WebApp.initDataUnsafe?.user?.id;
      
      if (telegramId) {
        // Directly process the payment
        fetch('/api/process-payment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            session_id: sessionId,
            telegram_id: telegramId
          })
        })
        .then(response => response.json())
        .then(result => {
          console.log('Processing result:', result);
          if (result.success) {
            updateMessage("✅ Payment successful! Thank you.<br><br>Your QR code is being sent to the chat.", 'status-complete');
          } else {
            updateMessage("⚠️ Payment processing failed.<br><br>Please contact support if this persists.", 'status-error');
          }
          
          // Auto-close after success
          if (result.success && window.Telegram && window.Telegram.WebApp) {
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            setTimeout(() => {
              Telegram.WebApp.close();
            }, 3000);
          }
        })
        .catch(err => {
          console.error('Processing failed:', err);
          updateMessage("⚠️ An error occurred while processing payment.<br><br>Please check your Telegram chat for confirmation.", 'status-error');
        });
      } else {
        updateMessage("⚠️ Unable to identify user.<br><br>Please return to the bot and try again.", 'status-error');
      }
    } else {
      updateMessage(
        "No payment session found.<br><br>Please return to the bot and try again.",
        'status-error'
      );
    }
  </script>


</body>
</html>

