<!DOCTYPE html>
<html><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Payment Status</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://js.stripe.com/v3/"></script>
<style>
  body {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: system-ui;
    text-align: center;
    padding: 20px;
    box-sizing: border-box;
    background: #f9fafb;
  }
  #message {
    font-size: 16px;
    margin-bottom: 20px;
    padding: 2rem 2.5rem;
    background: #fff;
    border-radius: 1rem;
    box-shadow: 0 4px 18px rgba(0,0,0,.08);
  }
  .status-complete { color: #22c55e; }
  .status-open { color: #f59e0b; }
  .status-expired { color: #ef4444; }
  .status-error { color: #ef4444; }
  .spinner {
    width: 24px;
    height: 24px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 10px auto;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
</head>
<body>

<div id="message">
  <div class="spinner"></div>
  Loading payment status...
</div>

<script>
  Telegram.WebApp.ready();
  
  const stripe = Stripe('pk_test_51RSmgFHILCjSlj9r8aaZUKvBDt66nmhRiw5rNa6MbAoOC2PU2WCSfvqMkkIc8Z6KPin0bRJbuHQR0hayywU552wy00CtP4mF3r');
  const messageDiv = document.getElementById('message');

  const urlParams = new URLSearchParams(window.location.search);
  const sessionId = urlParams.get('session_id');

  function updateMessage(text, className) {
    messageDiv.innerHTML = text; // Remove spinner
    messageDiv.className = className;
  }

  if (sessionId) {
    // Use fetch to get session status from your backend instead of Stripe.js
    fetch(`/api/session-status?session_id=${sessionId}`)
      .then(response => response.json())
      .then(data => {
        console.log('Session status:', data);
        
        let userMessage = '';
        let messageClass = '';
        let autoClose = false;

        switch (data.status) {
          case 'complete':
            // If payment is complete, try to process it manually
            if (data.payment_status === 'paid') {
              console.log('Payment is complete, attempting manual processing...');
              
              // Get telegram ID from Telegram WebApp
              const telegramId = Telegram.WebApp.initDataUnsafe?.user?.id;
              
              if (telegramId) {
                // Trigger manual payment processing
                fetch('/api/manual-process-payment', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    session_id: sessionId,
                    telegram_id: telegramId
                  })
                })
                .then(response => response.json())
                .then(result => {
                  console.log('Manual processing result:', result);
                  if (result.success) {
                    userMessage = "✅ Payment successful! Thank you.<br><br>Your QR code is being sent to the chat.";
                    messageClass = 'status-complete';
                    autoClose = true;
                  } else {
                    userMessage = "✅ Payment successful! Thank you.<br><br>Your QR code will be sent shortly.";
                    messageClass = 'status-complete';
                    autoClose = true;
                  }
                  updateMessage(userMessage, messageClass);
                  
                  if (autoClose && window.Telegram && window.Telegram.WebApp) {
                    Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    setTimeout(() => {
                      Telegram.WebApp.close();
                    }, 3000);
                  }
                })
                .catch(err => {
                  console.error('Manual processing failed:', err);
                  userMessage = "✅ Payment successful! Thank you.<br><br>Your QR code will be sent in the chat.";
                  messageClass = 'status-complete';
                  autoClose = true;
                  updateMessage(userMessage, messageClass);
                  
                  if (autoClose && window.Telegram && window.Telegram.WebApp) {
                    Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    setTimeout(() => {
                      Telegram.WebApp.close();
                    }, 3000);
                  }
                });
              } else {
                userMessage = "✅ Payment successful! Thank you.<br><br>Your QR code will be sent in the chat.";
                messageClass = 'status-complete';
                autoClose = true;
                updateMessage(userMessage, messageClass);
                
                if (autoClose && window.Telegram && window.Telegram.WebApp) {
                  Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                  setTimeout(() => {
                    Telegram.WebApp.close();
                  }, 3000);
                }
              }
            } else {
              userMessage = "✅ Payment successful! Thank you.<br><br>Your QR code will be sent in the chat.";
              messageClass = 'status-complete';
              autoClose = true;
              updateMessage(userMessage, messageClass);
            }
            break;
          case 'open':
            userMessage = "⏳ Your payment is still processing.<br><br>We'll notify you once completed.";
            messageClass = 'status-open';
            updateMessage(userMessage, messageClass);
            break;
          case 'expired':
            userMessage = "⚠️ Payment session expired.<br><br>Please go back and try again.";
            messageClass = 'status-expired';
            updateMessage(userMessage, messageClass);
            break;
          default:
            userMessage = `⚠️ Payment status: ${data.status}.<br><br>Please contact support if this persists.`;
            messageClass = 'status-error';
            updateMessage(userMessage, messageClass);
            break;
        }

      }).catch(err => {
        console.error('Error retrieving session:', err);
        updateMessage(
          "An error occurred while checking payment status.<br><br>" +
          "Please check your Telegram chat for confirmation.",
          'status-error'
        );
      });
  } else {
    updateMessage(
      "No payment session found.<br><br>Please return to the bot and try again.",
      'status-error'
    );
  }
</script>
</body></html>