<!DOCTYPE html>
<html><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Payment Status</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  body {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    font-family: system-ui;
    text-align: center;
    padding: 20px;
    box-sizing: border-box;
    background: #f9fafb;
  }
  #message {
    font-size: 16px;
    margin-bottom: 20px;
    padding: 2rem 2.5rem;
    background: #fff;
    border-radius: 1rem;
    box-shadow: 0 4px 18px rgba(0,0,0,.08);
  }
  .status-complete { color: #22c55e; }
  .status-open { color: #f59e0b; }
  .status-expired { color: #ef4444; }
  .status-error { color: #ef4444; }
  .spinner {
    width: 24px;
    height: 24px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 10px auto;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
</head>
<body>

<div id="message">
  <div class="spinner"></div>
  Loading payment status...
</div>

<script>
  Telegram.WebApp.ready();
  
  const messageDiv = document.getElementById('message');

  const urlParams = new URLSearchParams(window.location.search);
  const sessionId = urlParams.get('session_id');

  function updateMessage(text, className) {
    messageDiv.innerHTML = text; // Remove spinner
    messageDiv.className = className;
  }

  if (sessionId) {
    console.log('Processing payment for session:', sessionId);
    
    // Get telegram ID from Telegram WebApp
    const telegramId = Telegram.WebApp.initDataUnsafe?.user?.id;
    
    if (telegramId) {
      // Directly process the payment
      fetch('/api/process-payment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          session_id: sessionId,
          telegram_id: telegramId
        })
      })
      .then(response => response.json())
      .then(result => {
        console.log('Processing result:', result);
        if (result.success) {
          updateMessage("✅ Payment successful! Thank you.<br><br>Your QR code is being sent to the chat.", 'status-complete');
        } else {
          updateMessage("⚠️ Payment processing failed.<br><br>Please contact support if this persists.", 'status-error');
        }
        
        // Auto-close after success
        if (result.success && window.Telegram && window.Telegram.WebApp) {
          Telegram.WebApp.HapticFeedback.notificationOccurred('success');
          setTimeout(() => {
            Telegram.WebApp.close();
          }, 3000);
        }
      })
      .catch(err => {
        console.error('Processing failed:', err);
        updateMessage("⚠️ An error occurred while processing payment.<br><br>Please check your Telegram chat for confirmation.", 'status-error');
      });
    } else {
      updateMessage("⚠️ Unable to identify user.<br><br>Please return to the bot and try again.", 'status-error');
    }
  } else {
    updateMessage(
      "No payment session found.<br><br>Please return to the bot and try again.",
      'status-error'
    );
  }
</script>
</body></html>