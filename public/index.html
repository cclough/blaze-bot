<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Blaze Test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body{margin:0;display:flex;justify-content:center;align-items:center;height:100vh;
         font-family:system-ui;background:#f9fafb}
    .box{padding:2rem 2.5rem;background:#fff;border-radius:1rem;box-shadow:0 4px 18px rgba(0,0,0,.08);
         text-align:center}
    h1{font-size:1.25rem;margin:0 0 .5rem}
    p{margin:0;font-size:.95rem;color:#374151}
    #checkout {
      width: 100%;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="box">
    <h1>Blaze Cytokine Panel</h1>
    <p>$1 donation to cover lab cost</p>
  </div>
  <div id="checkout" style="display: none;"></div>

<script>
Telegram.WebApp.ready();
const btn = Telegram.WebApp.MainButton;
const boxElement = document.querySelector('.box');
const checkoutElement = document.getElementById('checkout');

const stripe = Stripe('pk_test_51RSmgFHILCjSlj9r8aaZUKvBDt66nmhRiw5rNa6MbAoOC2PU2WCSfvqMkkIc8Z6KPin0bRJbuHQR0hayywU552wy00CtP4mF3r');

btn.setText('Pay $1').show();

btn.onClick(async () => {
  btn.showProgress();

  const tgid = Telegram.WebApp.initDataUnsafe.user.id;
  const response = await fetch(`https://blaze-bot-five.vercel.app/api/create-checkout?tgid=${tgid}`);
  const { client_secret, error } = await response.json();

  if (error) {
    console.error('Error from backend:', error);
    Telegram.WebApp.showAlert('Could not initiate payment. ' + error);
    btn.hideProgress();
    return;
  }

  if (!client_secret) {
    console.error('Client secret not received');
    Telegram.WebApp.showAlert('Could not initiate payment. Missing client secret.');
    btn.hideProgress();
    return;
  }
  
  if (boxElement) boxElement.style.display = 'none';
  checkoutElement.style.display = 'block';
  btn.hide();

  try {
    const checkout = await stripe.initEmbeddedCheckout({
      clientSecret: client_secret,
    });

    checkout.mount('#checkout');
  } catch (e) {
    console.error('Error mounting Stripe checkout:', e);
    Telegram.WebApp.showAlert('Could not display payment form. ' + e.message);
    if (boxElement) boxElement.style.display = 'block';
    checkoutElement.style.display = 'none';
    btn.setText('Pay $1').show();
    btn.hideProgress();
  }
});
</script>
</body>
</html>